-- ✈️ Coordinate Tester GUI Full (Final + TP Floating GUI + Undo/Redo Fixed)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LP = Players.LocalPlayer

-- Variabel
local coords = {}
local undoStack, redoStack = {}
local running = false
local repeatOn, respawnOn = false, false
local flySpeed = 300 -- studs per detik
local noclipActive = false
local noclipConnection
local flyThread

-- Noclip
local function enableNoclip()
    if noclipActive then return end
    noclipActive = true
    noclipConnection = RunService.Stepped:Connect(function()
        local char = LP.Character
        if char then
            for _, part in ipairs(char:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end
    end)
end

local function disableNoclip()
    noclipActive = false
    if noclipConnection then
        noclipConnection:Disconnect()
        noclipConnection = nil
    end
    local char = LP.Character
    if char then
        for _, part in ipairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = true
            end
        end
    end
end

-- === GUI ===
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
ScreenGui.Name = "CoordTester"

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 420, 0, 320)
MainFrame.Position = UDim2.new(0.3,0,0.3,0)
MainFrame.BackgroundColor3 = Color3.fromRGB(40,40,40)
MainFrame.Active, MainFrame.Draggable = true,true
Instance.new("UICorner", MainFrame)

-- Header
local Header = Instance.new("TextLabel", MainFrame)
Header.Size = UDim2.new(1,-30,0,30)
Header.Position = UDim2.new(0,0,0,0)
Header.BackgroundColor3 = Color3.fromRGB(25,25,25)
Header.Text = "teleport by jsy"
Header.TextColor3 = Color3.fromRGB(255,255,255)
Header.Font = Enum.Font.SourceSansBold
Header.TextSize = 18
Instance.new("UICorner", Header)

-- Minimize
local MinBtn = Instance.new("TextButton", MainFrame)
MinBtn.Size = UDim2.new(0,30,0,30)
MinBtn.Position = UDim2.new(1,-30,0,0)
MinBtn.Text = "-"
MinBtn.BackgroundColor3 = Color3.fromRGB(100,0,0)
MinBtn.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", MinBtn)

-- Mini GUI Floating (kotak kecil TP)
local MiniFrame = Instance.new("Frame", ScreenGui)
MiniFrame.Size = UDim2.new(0,60,0,40)
MiniFrame.Position = UDim2.new(0,10,0,10)
MiniFrame.BackgroundColor3 = Color3.fromRGB(0,0,0)
MiniFrame.Visible = true
MiniFrame.Active, MiniFrame.Draggable = true,true
Instance.new("UICorner", MiniFrame)

local OpenBtn = Instance.new("TextButton", MiniFrame)
OpenBtn.Size = UDim2.new(1,0,1,0)
OpenBtn.Text = "TP"
OpenBtn.BackgroundTransparency = 1
OpenBtn.TextColor3 = Color3.fromRGB(255,255,255)
OpenBtn.Font = Enum.Font.SourceSansBold
OpenBtn.TextSize = 18

-- CoordBox
local CoordBox = Instance.new("TextBox", MainFrame)
CoordBox.Size = UDim2.new(0.6,-10,0.6,-40)
CoordBox.Position = UDim2.new(0,5,0,35)
CoordBox.BackgroundColor3 = Color3.fromRGB(60,60,60)
CoordBox.ClearTextOnFocus = false
CoordBox.MultiLine = true
CoordBox.TextXAlignment = Enum.TextXAlignment.Left
CoordBox.TextYAlignment = Enum.TextYAlignment.Top
CoordBox.Font = Enum.Font.Code
CoordBox.TextSize = 14
CoordBox.TextColor3 = Color3.fromRGB(255,255,255)
CoordBox.Text = ""
Instance.new("UICorner", CoordBox)

-- Right Panel Buttons
local RightPanel = Instance.new("Frame", MainFrame)
RightPanel.Size = UDim2.new(0.4,-10,0.6,-40)
RightPanel.Position = UDim2.new(0.6,5,0,35)
RightPanel.BackgroundTransparency = 1

local function createBtn(text, order, color)
    local btn = Instance.new("TextButton", RightPanel)
    btn.Size = UDim2.new(1,0,0,30)
    btn.Position = UDim2.new(0,0,0,(order-1)*35)
    btn.Text = text
    btn.BackgroundColor3 = color or Color3.fromRGB(0,120,255)
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 16
    Instance.new("UICorner", btn)
    return btn
end

local SaveBtn = createBtn("Save",1)
local UndoBtn = createBtn("Undo",2)
local RedoBtn = createBtn("Redo",3)
local RepeatBtn = createBtn("Repeat",4,Color3.fromRGB(200,0,0))
local RespawnBtn = createBtn("Respawn",5,Color3.fromRGB(200,0,0))

-- Bottom
local BottomFrame = Instance.new("Frame", MainFrame)
BottomFrame.Size = UDim2.new(1,-10,0,35)
BottomFrame.Position = UDim2.new(0,5,1,-40)
BottomFrame.BackgroundTransparency = 1

local StartBtn = Instance.new("TextButton", BottomFrame)
StartBtn.Size = UDim2.new(0,100,1,0)
StartBtn.Position = UDim2.new(0,0,0,0)
StartBtn.Text = "Start"
StartBtn.BackgroundColor3 = Color3.fromRGB(0,200,0)
StartBtn.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", StartBtn)

local StopBtn = Instance.new("TextButton", BottomFrame)
StopBtn.Size = UDim2.new(0,100,1,0)
StopBtn.Position = UDim2.new(0,110,0,0)
StopBtn.Text = "Stop"
StopBtn.BackgroundColor3 = Color3.fromRGB(200,0,0)
StopBtn.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", StopBtn)

local DelayBox = Instance.new("TextBox", BottomFrame)
DelayBox.Size = UDim2.new(0,120,1,0)
DelayBox.Position = UDim2.new(1,-120,0,0)
DelayBox.PlaceholderText = "atur delay"
DelayBox.Text = ""
DelayBox.BackgroundColor3 = Color3.fromRGB(70,70,70)
DelayBox.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", DelayBox)

-- Progress
local ProgressText = Instance.new("TextLabel", MainFrame)
ProgressText.Size = UDim2.new(1,-10,0,20)
ProgressText.Position = UDim2.new(0,5,0.65,-10)
ProgressText.BackgroundTransparency = 1
ProgressText.Text = "Progress: 0 / 0"
ProgressText.TextColor3 = Color3.fromRGB(255,255,255)
ProgressText.Font = Enum.Font.SourceSansBold
ProgressText.TextSize = 14

local ProgressBar = Instance.new("Frame", MainFrame)
ProgressBar.Size = UDim2.new(1,-10,0,15)
ProgressBar.Position = UDim2.new(0,5,0.65,15)
ProgressBar.BackgroundColor3 = Color3.fromRGB(80,80,80)
Instance.new("UICorner", ProgressBar)

local ProgressFill = Instance.new("Frame", ProgressBar)
ProgressFill.Size = UDim2.new(0,0,1,0)
ProgressFill.BackgroundColor3 = Color3.fromRGB(0,200,0)
Instance.new("UICorner", ProgressFill)

-- === Helper Functions ===
local function updateProgress(current,total)
    ProgressText.Text = string.format("Progress: %d / %d",current,total)
    if total>0 then
        ProgressFill.Size = UDim2.new(current/total,0,1,0)
    else
        ProgressFill.Size = UDim2.new(0,0,1,0)
    end
end

local function parseCoords()
    coords = {}
    for line in CoordBox.Text:gmatch("[^\r\n]+") do
        local x,y,z = line:match("([%-%d%.]+)%s*,%s*([%-%d%.]+)%s*,%s*([%-%d%.]+)")
        if x and y and z then
            table.insert(coords, Vector3.new(tonumber(x),tonumber(y),tonumber(z)))
        end
    end
    updateProgress(0,#coords)
end

local function RespawnCharacter()
    if LP and LP.Character then
        local char = LP.Character
        local humanoid = char:FindFirstChildOfClass("Humanoid")
        if humanoid then humanoid.Health = 0 end
        task.wait(1)
        LP:LoadCharacter()
    end
end

-- Fly to position
local function flyTo(targetPos)
    local char = LP.Character
    if not char then return false end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if not hrp or not humanoid then return false end

    enableNoclip()
    humanoid.PlatformStand = true

    local bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.MaxForce = Vector3.new(1e5,1e5,1e5)
    bodyVelocity.Velocity = Vector3.new(0,0,0)
    bodyVelocity.Parent = hrp

    while running do
        local dir = targetPos - hrp.Position
        local dist = dir.Magnitude
        if dist < 0.5 then break end
        local speed = math.min(flySpeed, dist * 8)
        bodyVelocity.Velocity = dir.Unit * speed
        humanoid.Health = humanoid.MaxHealth
        task.wait()
    end

    bodyVelocity.Velocity = Vector3.new(0,0,0)
    task.wait()
    bodyVelocity:Destroy()
    humanoid.PlatformStand = false
    disableNoclip()
end

-- Fly through coords
local function flyThroughCoords()
    running = true
    flyThread = coroutine.wrap(function()
        while running do
            parseCoords()
            for i,targetPos in ipairs(coords) do
                if not running then break end
                if LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
                    flyTo(targetPos)
                end
                updateProgress(i,#coords)
                local delayTime = tonumber(DelayBox.Text) or 1
                task.wait(delayTime)
            end

            -- Tunggu 2 detik di koordinat terakhir sebelum respawn
            if respawnOn and #coords > 0 then
                task.wait(2)
                RespawnCharacter()
                task.wait(3)
            end

            if not repeatOn then break end
        end
        running = false
        flyThread = nil
        updateProgress(0,#coords)
    end)
    flyThread()
end

-- === Undo/Redo Helper ===
local function pushUndo()
    table.insert(undoStack, CoordBox.Text)
    if #undoStack > 50 then table.remove(undoStack,1) end
end

-- === Button Logic ===
SaveBtn.MouseButton1Click:Connect(function()
    if LP.Character and LP.Character:FindFirstChild("HumanoidRootPart") then
        pushUndo()
        local pos = LP.Character.HumanoidRootPart.Position
        CoordBox.Text = CoordBox.Text .. string.format("%s, %s, %s\n",
            math.floor(pos.X*100)/100,
            math.floor(pos.Y*100)/100,
            math.floor(pos.Z*100)/100
        )
        redoStack = {} -- reset redoStack saat input baru
    end
end)

UndoBtn.MouseButton1Click:Connect(function()
    if #undoStack > 0 then
        table.insert(redoStack, CoordBox.Text)
        CoordBox.Text = table.remove(undoStack)
    end
end)

RedoBtn.MouseButton1Click:Connect(function()
    if #redoStack > 0 then
        table.insert(undoStack, CoordBox.Text)
        CoordBox.Text = table.remove(redoStack)
    end
end)

StartBtn.MouseButton1Click:Connect(function()
    if not running then
        flyThroughCoords()
    end
end)

StopBtn.MouseButton1Click:Connect(function()
    running = false
    disableNoclip()
end)

RepeatBtn.MouseButton1Click:Connect(function()
    repeatOn = not repeatOn
    RepeatBtn.BackgroundColor3 = repeatOn and Color3.fromRGB(0,200,0) or Color3.fromRGB(200,0,0)
end)

RespawnBtn.MouseButton1Click:Connect(function()
    respawnOn = not respawnOn
    RespawnBtn.BackgroundColor3 = respawnOn and Color3.fromRGB(0,200,0) or Color3.fromRGB(200,0,0)
end)

MinBtn.MouseButton1Click:Connect(function()
    MainFrame.Visible = false
    MiniFrame.Visible = true
end)

OpenBtn.MouseButton1Click:Connect(function()
    MainFrame.Visible = true
    MiniFrame.Visible = false
end)

-- CharacterAdded hanya fly otomatis kalau repeatOn aktif
LP.CharacterAdded:Connect(function(char)
    char:WaitForChild("HumanoidRootPart",5)
    if repeatOn then
        flyThroughCoords()
    end
end)
